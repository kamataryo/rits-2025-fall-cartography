---
marp: true
theme: default
class: title
paginate: true
---

<script src="https://g69ye6vo2a.execute-api.ap-northeast-1.amazonaws.com/v1/client/vote-client.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("section").forEach(section => {
      const reaction = document.createElement("reaction-component");
      reaction.setAttribute("emojis", "👍,👎,🤔,💡");
      section.appendChild(reaction);
    });
  });
</script>
<style>
/* ページ番号は右上。リアクションコンポーネントをおきたいので */
section.title::after { top: 21px; }
</style>

<!-- _class: title -->

# MapLibre GL JS と OpenStreetMap で始める<br />ウェブカートグラフィ入門

## ウェブ地図の構成要素

立命館大学 2025年度 秋セメスター 火曜5限
授業時間：95分

---

## 本日のアジェンダ

1. **前回の振り返り・課題確認** (12分)
3. **タイルの仕組み** (28分)
4. **MapLibre GL JS の概要とセットアップ** (27分)
5. **実習・質疑応答** (5分)

---

## 前回の振り返り

- OpenStreetMapについて
- OSMコミュニティとデータ作成プロセス
- Osmium 及び Python を使ったデータ処理

### 課題の確認

- Osmium を使った Python のプログラムを利用して、さまざまなデータを抽出してみる

---

### タイルベース地図の概念

#### タイルとは？
> 地図を小さな正方形の画像に分割したもの

#### 基本的な仕組み
1. **分割**：地図を256×256ピクセルのタイルに分割（512ピクセルの高解像度を利用するケースが多い）
2. **階層化**：ズームレベルごとに異なる解像度
3. **配信**：必要なタイル**のみ**を必要な時にダウンロード
4. **表示**：タイルを敷き詰めて地図を構成

---

## 実習: タイル配信を観察する

地理院地図を使ってタイル配信の仕組みを調査する

### 手順　

1. [地理院地図](https://maps.gsi.go.jp/)を開く
2. 開発ツールを開く(F12キーを押す)
3. **ネットワーク** タブを開く
4. 地理院地図をリロード(🔁ボタン)
5. どのようなファイルがダウンロードされているかを観察
6. 地図を動かしたり、ズームインしたりしてみて、再度観察

---

### ズームレベルとタイル数

https://kamataryo.github.io/vector-grids/
ズームが1上がるごとに、地図を4分割する

---

#### ズームレベルの定義

- **レベル0**：全世界を1枚のタイルで表現
- **レベル1**：全世界を4枚のタイルで表現
- **レベル2**：全世界を16枚のタイルで表現
- **レベルn**：全世界を4<sup>n</sup> 枚のタイルで表現

---

#### 解像度の関係

https://blog.geolonia.com/2020/07/06/zoom-level

---

### 実習

1. ズームレベル 10 では、タイルの枚数は何枚になるか計算してみる
2. ズームレベル 0 - 10 の全体では、タイルの枚数は合計何枚になるか計算してみる

---

<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

## 回答

1. ズーム10 では、<span>$4^{10} = 1{,}048{,}576$</span>
2. 0-10までのタイル総数は、<span>$\sum_{k=0}^{10} 4^{k} = \sum_{k=1}^{11} 4^{k-1} = \frac{4^{11}-1}{3}=1{,}398{,}101$</span> 

---

### タイル座標系

```
Z/X/Y 形式
Z: ズームレベル
X: 横方向(東西)のタイル番号
Y: 縦方向(南北)のタイル番号
```

#### 例：大阪駅周辺（ズームレベル15）

```
https://tile.openstreetmap.org/15/28719/13011.png
```

<img width=256 src="https://tile.openstreetmap.org/15/28719/13011.png" />

---

### 実習

1. 以下のURLをブラウザのアドレスバーに入力
https://tile.openstreetmap.org/15/28719/13011.png

2. X 成分、Y 成分を +-1 して、上下左右の隣に移動できるのを確認してみる。

---

## ラスタータイル vs ベクタータイル

### ラスタータイル（Raster Tiles）

#### 特徴
- **形式**：PNG、JPEG などの画像ファイル
- **事前生成**：サーバー側で描画済み
- **固定スタイル**：クライアント側での変更不可

#### メリット
- **高速表示**：画像の表示のみ
- **複雑な表現**：写真、複雑なスタイル

---

#### デメリット
- **ファイルサイズ大**：画像データ
- **スタイル変更不可**：固定デザイン
- **テキスト回転不可**：ラベルの向き固定

---

### ベクタータイル（Vector Tiles）

#### 特徴
- **形式**：PBF（Protocol Buffers）、JSON
- **ベクターデータ**：点・線・面の座標情報
- **クライアント描画**：ブラウザ側でレンダリング

#### メリット
- **クライアントサイドでのスタイリング**：動的な色・サイズ変更
- **高解像度対応**：任意の解像度で描画可能
- **テキスト回転**：地図回転時のラベル追従
- **インタラクション**：クリック・ホバー対応

---

#### デメリット
- **クライアント負荷**：描画処理が重い
- **複雑な実装**：スタイル定義が必要

---

### タイル形式の比較

| 特徴 | ラスタータイル | ベクタータイル |
|------|----------------|----------------|
| **ファイルサイズ** | 大きい | 小さい |
| **表示速度** | 高速 | 中程度 |
| **カスタマイズ性** | 低い | 高い |
| **高解像度対応** | 困難 | 容易 |
| **インタラクション** | 制限あり | 豊富 |
| **利用が簡単か** | 簡単 | 複雑 |

---

## MapLibre GL JS の概要

### MapLibre GL JS とは？

#### 概要
> オープンソースの WebGL ベース地図ライブラリ

#### 特徴
- **オープンソース**：MIT ライセンス
- **Mapbox GL JS のフォーク**：2020年に分岐
- **ベクタータイル対応**：高性能な地図表示
- **カスタマイズ性**：柔軟なスタイリング

---

### MapLibre GL JS の歴史

#### 背景
- **2020年**：Mapbox GL JS v2 が商用ライセンスに変更
- **コミュニティの対応**：オープンソース版の継続開発

---

### 主要な機能

#### 1. ベクタータイル表示
- **高速レンダリング**：WebGL による GPU 活用
- **スムーズなズーム**：連続的な拡大縮小
- **回転・傾斜**：3D 的な地図操作

#### 2. スタイリング
- **JSON ベース**：Mapbox Style Specification
- **レイヤー管理**：複数レイヤーの重ね合わせ
- **データドリブン**：属性値による動的スタイル

---

#### 3. インタラクション
- **イベント処理**：クリック・ホバー・ドラッグ
- **ポップアップ**：情報表示ウィンドウ
- **アニメーション**：スムーズな画面遷移

#### 4. データソース
- **GeoJSON**：直接読み込み
- **ベクタータイル**：効率的な大量データ
- **ラスタータイル**：従来形式との互換性
- **画像・動画**：メディアの重ね合わせ

---

## 実習(提出課題)

1. OpenStreetMap から任意のデータを抜き出して GeoJSON に変換
2. GeoJSON を Maplibre GL JS に表示する
3. 地図を好きな形にカスタマイズする
4. GitHub Pages として公開

---

## 1.OpenStreetMap から任意のデータを抜き出して GeoJSON に変換

前回利用した Osmium のリポジトリを活用する
> https://github.com/kamataryo/rits-2025-fall-cartography__06-python-osmium

1-1. 03_tag_filter_and_transform_to_geojson.py を実行
1-2. 出力した　GeoJSON ファイルをダウンロード
1-3. [geojson.io](https://geojson.io) などで確認

---

## 2. GeoJSON を Maplibre GL JS に表示する

2-1. 以下のリポジトリを、「フォーク」した後に、Codespace で起動する。
https://github.com/kamataryo/rits-2025-fall-cartography__08-webmap-sample

2-2. 1 でダウンロードした GeoJSON をアップロード
2-3. sample.geojson を置き換えて、表示を確認してみる

## 3. 地図を好きな形にカスタマイズする

- 地図の中心やズーム、最大・最小ズームを、置き換えた GeoJSON を見やすいものに変更してみる
- サークルレイヤーの色や大きさを変更してみる
- シンボルレイヤー（テキスト）の色や大きさ、配置を変更してみる
- name 以外のプロパティを表示してみる
- クリックしたときに、name 以外のプロパティを表示してみる

---

### 提出物

フォークした当該リポジトリの URL。 

### 提出期限・方法
- **期限**：次回授業開始時
- **方法**：Manaba+R経由

---

## 次回予告

### 第7-8回：MapLibre GL JS の基礎操作
- 地図の基本操作（移動・拡大縮小）
- 地図のカスタマイズ方法
- レイヤー追加
- JSON形式でのスタイル定義

---

<!-- _class: title -->

# ありがとうございました

## 次回もよろしくお願いします

**第9回：MapLibre GL JS の基礎操作**

課題の提出をお忘れなく！
