---
marp: true
theme: default
class: title
paginate: true
---

<script src="https://g69ye6vo2a.execute-api.ap-northeast-1.amazonaws.com/v1/client/vote-client.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("section").forEach(section => {
      const reaction = document.createElement("reaction-component");
      reaction.setAttribute("emojis", "👍,👎,🤔,💡");
      section.appendChild(reaction);
    });
  });
</script>
<style>
/* ページ番号は右上。リアクションコンポーネントをおきたいので */
section.title::after { top: 21px; }
</style>

<!-- _class: title -->

# MapLibre GL JS と OpenStreetMap で始める<br />ウェブカートグラフィ入門

## 第6回：ウェブ地図の構成要素

立命館大学 2025年度 秋セメスター 火曜5限
授業時間：95分

---

## 本日のアジェンダ

1. **前回の振り返り・課題確認** (12分)
2. **ベースマップとオーバーレイの違い** (23分)
3. **タイルの仕組み** (28分)
4. **MapLibre GL JS の概要とセットアップ** (27分)
5. **実習・質疑応答** (5分)

---

## 前回の振り返り

### 第4-5回の主要ポイント
- OpenStreetMapについて
- OSMコミュニティとデータ作成プロセス
- Overpass Turbo を使ったデータ取得

### 課題の確認

- Overpass Turbo を使った興味のあるエリアのデータ調査

---

## ベースマップとオーバーレイの違い

### ウェブ地図の構成要素

#### 基本的な構造

```
ウェブ地図 = ベースマップ + オーバーレイ + UI要素
```

※ ただし、ベースマップとオーバーレイには明瞭な区別がない場合もあり

---

### ベースマップ

#### 定義
> 地図の背景となる基本的な地理情報を表示するレイヤー

#### 主要な要素
- **道路網**：高速道路、国道、県道、市道
- **地形**：山、川、湖、海岸線
- **行政境界**：国境、都道府県境、市町村境
- **土地利用**：森林、農地、市街地
- **地名**：都市名、地域名、施設名

---

#### ベースマップの種類

- 道路地図
- 衛星画像や航空写真
- 地形図
- 白地図
- etc.

---

### オーバーレイ

#### 定義
> ベースマップの上に重ねて表示される追加の情報レイヤー

#### 主要な種類
- **ポイントデータ**：店舗、施設、イベント地点、 etc.
- **ルートデータ**：移動経路、境界線、etc.
- **エリアデータ**：行政区域、影響範囲

#### 時間的な分類
- **統計データ**: 農業/工業等の生産統計、国勢調査データ
- **リアルタイムデータ**：交通情報、気象情報

---

### UI 要素

> ユーザーインターフェース: ユーザーとコンピューターの境界

- 地図の移動・拡大・縮小
- ベースマップを切り替える (絵地図 <-> 航空写真 など)
- オーバーレイを切り替える (分析対象を変更する、など)

---

### ベースマップとタイル

### タイルベース地図の概念

#### タイルとは？
> 地図を小さな正方形の画像に分割したもの

#### 基本的な仕組み
1. **分割**：地図を256×256ピクセルのタイルに分割（512ピクセルの高解像度を利用するケースが多い）
2. **階層化**：ズームレベルごとに異なる解像度
3. **配信**：必要なタイル**のみ**を必要な時にダウンロード
4. **表示**：タイルを敷き詰めて地図を構成

---

## 実習: タイル配信を観察する

地理院地図を使ってタイル配信の仕組みを調査する

### 手順　

1. [地理院地図](https://maps.gsi.go.jp/)を開く
2. 開発ツールを開く(F12キーを押す)
3. **ネットワーク** タブを開く
4. 地理院地図をリロード(🔁ボタン)
5. どのようなファイルがダウンロードされているかを観察
6. 地図を動かしたり、ズームインしたりしてみて、再度観察

---

### ズームレベルとタイル数

https://kamataryo.github.io/vector-grids/
ズームが1上がるごとに、地図を4分割する

---

#### ズームレベルの定義
- **レベル0**：全世界を1枚のタイル（256×256px）
- **レベル1**：全世界を4枚のタイル（2×2）
- **レベル2**：全世界を16枚のタイル（4×4）
- **レベルn**：全世界を4^n枚のタイル

---

#### 解像度の関係

ズーム/緯度|0|10|20|30|40|50|60|70|80
|||||||||
1	20021.37km	 	 	 	 	 	 	 	 
2	10010.68km	 	 	 	 	 	 	3641.25km	 
3	5005.34km	 	 	 	 	3735.61km	 	1951.55km	917.17km
4	2502.67km	 	 	2319.26km	 	1884.1km	1401.35km	992.01km	467.27km
5	1251.34km	 	1227.52km	1160.42km	1061.27km	821.48km	703km	498.03km	234.73km
6	625.67km	622.66km	599.46km	557.13km	502.24km	411.02km	323.89km	227.64km	117.5km
7	312.83km	309.47km	295.23km	272.18km	243.72km	205.54km	161.98km	108.74km	56km
8	156.42km	154.14km	147.62km	136.09km	119.98km	100.88km	79.31km	54.38km	27.33km
9	78.21km	77.07km	73.5km	68.05km	59.99km	50.44km	39.24km	26.88km	13.67km
10	39.1km	38.53km	36.75km	33.92km	30km	25.22km	19.62km	13.44km	6.79km
11	19.55km	19.26km	18.38km	16.93km	15km	12.58km	9.78km	6.7km	3.4km
12	9.78km	9.63km	9.19km	8.47km	7.49km	6.29km	4.89km	3.35km	1.7km
13	4.89km	4.81km	4.59km	4.23km	3.75km	3.14km	2.44km	1.67km	849.04m
14	2.44km	2.41km	2.3km	2.12km	1.87km	1.57km	1.22km	835.98m	424.52m
15	1.22km	1.2km	1.15km	1.06km	936.19m	785.6m	611.02m	417.99m	212.22m
16	611m	601.73m	574.16m	529.16m	468.07m	392.77m	305.51m	208.98m	106.11m
17	305.5m	300.86m	287.08m	264.58m	234.03m	196.38m	152.76m	104.49m	53.05m
18	152.75m	150.43m	143.54m	132.29m	117.02m	98.19m	76.38m	52.24m	26.53m
19	76.38m	75.22m	71.77m	66.14m	58.51m	49.09m	38.19m	26.12m	13.26m
20	38.19m	37.61m	35.88m	33.07m	29.25m	24.55m	19.09m	13.06m	663.12cm
21	19.09m	18.8m	17.94m	16.54m	14.63m	12.27m	954.7cm	653.05cm	331.56cm
22	954.69cm	940.19cm	897.12cm	826.79cm	731.34cm	613.67cm	477.35cm	326.52cm	165.78cm
23	477.35cm	470.09cm	448.56cm	413.39cm	365.67cm	306.83cm	238.67cm	163.26cm	82.89cm
24	238.67cm	235.05cm	224.28cm	206.7cm	182.83cm	153.42cm	119.34cm	81.63cm	41.45cm
25	119.34cm	117.52cm	112.14cm	103.35cm	91.42cm	76.71cm	59.67cm	40.82cm	20.72cm
26	59.67cm	58.76cm	56.07cm	51.67cm	45.71cm	38.35cm	29.83cm	20.41cm	10.36cm
27	29.83cm	29.38cm	28.03cm	25.84cm	22.85cm	19.18cm	14.92cm	10.2cm	5.18cm
28	14.92cm	14.69cm	14.02cm	12.92cm	11.43cm	9.59cm	7.46cm	5.1cm	2.59cm
29	7.46cm	7.35cm	7.01cm	6.46cm	5.71cm	4.79cm	3.73cm	2.55cm	1.3cm
30	3.73cm	3.67cm	3.5cm	3.23cm	2.86cm	2.4cm	1.86cm	1.28cm	0.65cm


---

### 実習

1. ズームレベル 20 では、タイルの枚数は何枚になるか計算してみる
2. ズームレベル 0 - 20 の全体では、タイルの枚数は合計何枚になるか計算してみる
3. タイルの画像が 256px x 256px のサイズでビットマップ形式だった時
    1. ズームレベル 20 ではどのくらいのサイズ(バイト数)になるか計算してみる
    2. ズームレベル 0 - 20 の全体ではどのくらいのサイズになるか計算してみる

ヒント:
- ビットマップ画像とは、無圧縮の画像。1ピクセルあたり3バイトの情報量があります。
- 1024バイト = 1キロバイト
- 1024キロバイト = 1メガバイト
- 1024メガバイト = 1ギガバイト
- 1024ギガバイト = 1テラバイト

---

### タイル座標系

// TODO: OSM Slippery Tile に変更

#### TMS（Tile Map Service）座標
```
Z/X/Y 形式
Z: ズームレベル
X: 横方向のタイル番号（西から東へ）
Y: 縦方向のタイル番号（南から北へ）
```

#### 例：大阪駅周辺（ズームレベル15）
```
https://tile.openstreetmap.org/15/29177/13212.png
```

<img src="https://tile.openstreetmap.org/15/29177/13212.png" />


---

## ラスタータイル vs ベクタータイル

### ラスタータイル（Raster Tiles）

#### 特徴
- **形式**：PNG、JPEG などの画像ファイル
- **事前生成**：サーバー側で描画済み
- **固定スタイル**：クライアント側での変更不可

#### メリット
- **高速表示**：画像の表示のみ
- **複雑な表現**：写真、複雑なスタイル

---

#### デメリット
- **ファイルサイズ大**：画像データ
- **スタイル変更不可**：固定デザイン
- **高解像度対応困難**：Retina ディスプレイ => 512px が主流
- **テキスト回転不可**：ラベルの向き固定

---

### ベクタータイル（Vector Tiles）

#### 特徴
- **形式**：PBF（Protocol Buffers）、JSON
- **ベクターデータ**：点・線・面の座標情報
- **クライアント描画**：ブラウザ側でレンダリング

#### メリット
- **リアルタイムスタイリング**：動的な色・サイズ変更
- **高解像度対応**：任意の解像度で描画
- **テキスト回転**：地図回転時のラベル追従
- **インタラクション**：クリック・ホバー対応

---

#### デメリット
- **クライアント負荷**：描画処理が重い
- **複雑な実装**：スタイル定義が必要
- **ブラウザ依存**：WebGL 対応必須

---

### タイル形式の比較

| 特徴 | ラスタータイル | ベクタータイル |
|------|----------------|----------------|
| **ファイルサイズ** | 大きい | 小さい |
| **表示速度** | 高速 | 中程度 |
| **カスタマイズ性** | 低い | 高い |
| **高解像度対応** | 困難 | 容易 |
| **インタラクション** | 制限あり | 豊富 |
| **実装複雑度** | 簡単 | 複雑 |

---

## ラスタータイルとベクタータイルの比較

TODO: 二本指でぐるっと

---

## MapLibre GL JS の概要

### MapLibre GL JS とは？

#### 概要
> オープンソースの WebGL ベース地図ライブラリ

#### 特徴
- **完全オープンソース**：MIT ライセンス
- **Mapbox GL JS のフォーク**：2020年に分岐
- **ベクタータイル対応**：高性能な地図表示
- **カスタマイズ性**：柔軟なスタイリング

---

### MapLibre GL JS の歴史

#### 背景
- **2020年**：Mapbox GL JS v2 が商用ライセンスに変更
- **コミュニティの対応**：オープンソース版の継続開発
- **MapLibre の誕生**：v1.15 をベースにフォーク

#### 現在の状況
- **活発な開発**：継続的なアップデート
- **企業採用**：多くの企業・組織が利用
- **エコシステム**：プラグイン・ツールの充実

---

### 主要な機能

#### 1. ベクタータイル表示
- **高速レンダリング**：WebGL による GPU 活用
- **スムーズなズーム**：連続的な拡大縮小
- **回転・傾斜**：3D 的な地図操作

#### 2. スタイリング
- **JSON ベース**：Mapbox Style Specification
- **レイヤー管理**：複数レイヤーの重ね合わせ
- **データドリブン**：属性値による動的スタイル

---

#### 3. インタラクション
- **イベント処理**：クリック・ホバー・ドラッグ
- **ポップアップ**：情報表示ウィンドウ
- **アニメーション**：スムーズな画面遷移

#### 4. データソース
- **GeoJSON**：直接読み込み
- **ベクタータイル**：効率的な大量データ
- **ラスタータイル**：従来形式との互換性
- **画像・動画**：メディアの重ね合わせ

---

## ウェブ地図を表示する

MapLibre GL JS を使用して、ベースマップを表示する

### 手順
1. HTML ファイルの作成
2. MapLibre GL JS の読み込み
3. 地図の初期化
4. 基本的なスタイル設定

// TODO: フォーク用のサンプルリポジトリを作成
// 解説と、以下の課題を調整

---

### 地図の基本設定

#### 主要なオプション
```javascript
const map = new maplibregl.Map({
  container: 'map',           // 必須：HTML要素のID
  style: styleObject,         // 必須：スタイル定義
  center: [lng, lat],         // 初期中心座標
  zoom: 10,                   // 初期ズームレベル
  bearing: 0,                 // 初期回転角度（度）
  pitch: 0,                   // 初期傾斜角度（度）
  minZoom: 0,                 // 最小ズームレベル
  maxZoom: 22,                // 最大ズームレベル
  maxBounds: bounds,          // 表示可能範囲の制限
  attributionControl: true,   // 著作権表示の有無
  navigationControl: true     // ナビゲーションコントロールの有無
});
```

---

- イベントハンドリング
- ユーザーインタラクション

---

## 実習：基本的なウェブページでの地図表示

### 実習目標


---

## 課題：MapLibre GL JS を利用してベースマップを表示する簡単なウェブページを作成

### 課題内容
MapLibre GL JS を使用して、自分の興味のある地域を中心とした地図を表示するウェブページを作成してください。

### 要件

#### 1. 技術要件
- **MapLibre GL JS** の最新版を使用
- **OpenStreetMap** をベースマップとして使用
- **レスポンシブデザイン** に対応
- **適切なHTML構造** とセマンティックなマークアップ

#### 2. 機能要件
- **初期表示位置** を自分の選んだ地域に設定
- **適切なズームレベル** で表示
- **基本的なナビゲーション** 機能（ズーム・パン）
- **コンソールでの座標表示** （クリック時）

</div>

---

<div class="assignment">

#### 3. デザイン要件
- **情報パネル** の追加（地図の説明・タイトル）
- **適切なスタイリング** （CSS）
- **ユーザビリティ** を考慮したレイアウト

#### 4. ドキュメント要件
- **コメント** の適切な記述
- **著作権表示** の適切な設定
- **メタタグ** の適切な設定

### 選択可能な地域例
- 出身地・居住地
- 大学・学校周辺
- 好きな観光地
- 思い出の場所
- 興味のある都市

</div>

---

<div class="assignment">

### 提出物

#### 1. HTML ファイル
- **ファイル名**：`[学籍番号]_map.html`
- **完全に動作する** 単一のHTMLファイル
- **外部依存なし**（CDN使用は可）

#### 2. レポート
- **形式**：A4用紙1-2枚程度（PDF形式）
- **内容**：
  - 選択した地域とその理由
  - 実装で工夫した点
  - 技術的な学び・発見
  - 今後の改善アイデア
  - 実行結果のスクリーンショット

</div>

---

<div class="assignment">

### 評価基準
- **技術的実装**（40%）
  - MapLibre GL JS の正しい使用
  - HTML/CSS の品質
  - 動作の確実性
- **デザイン・ユーザビリティ**（30%）
  - 見た目の美しさ
  - 使いやすさ
  - レスポンシブ対応
- **内容の充実度**（20%）
  - 地域選択の妥当性
  - 個人的な関連性
- **ドキュメント**（10%）
  - コメントの適切性
  - レポートの質

### 提出期限・方法
- **期限**：次回授業開始時
- **方法**：Manaba+R経由

</div>

---

## 次回予告

### 第7-8回：MapLibre GL JS の基礎操作
- 地図の基本操作（移動・拡大縮小）
- 地図のカスタマイズ方法
- レイヤー追加の実践
- JSON形式でのスタイル定義
- GeoJSONデータの地図表示

### 準備事項
- 今回作成したHTMLファイルの動作確認
- 前回作成したGeoJSONデータの準備
- MapLibre GL JS ドキュメントの予習

---

## 質疑応答

### 本日の内容について
- ベースマップとオーバーレイの概念
- タイルの仕組み・座標系
- MapLibre GL JS の基本的な使用方法
- 課題に関する技術的な質問

---

<!-- _class: title -->

# ありがとうございました

## 次回もよろしくお願いします

**第7-8回：MapLibre GL JS の基礎操作**
[日時・教室]

課題の提出をお忘れなく！
